<!--
`existdb-dashboard`
a eXistdb launchpad 

@demo demo/index.html
-->

<dom-module id="existdb-dashboard">
    <template>
        <style>
            :host {
                display: block;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                @apply(--paper-font-common-base);
                color: white;
                --app-drawer-scrim-background: rgba(0, 0, 0, 0.3);


            }
            paper-item{
                --paper-item-focused:{
                    background:white;
                };
                --paper-item-selected:{
                    background:white;
                };
                --paper-item-focused-before:{
                    background:white;
                }
            }

            app-toolbar {
                background: rgb(0, 136, 204);
                width: 100%;
                margin: 0;
            }

            app-drawer {
                /*background: rgba(245, 245, 245, 0.5);*/
                z-index: 100;
                text-align: center;
                color: black;
            }

            .drawerbar {
                width: 256px;
                height: 128px;
                display: table-cell;
                vertical-align: middle;
            }
            app-drawer-layout:not([narrow]) [drawer-toggle] {
                display: none;
            }

            .righttool {
                margin-right: 20px;
            }

            [icon=info-outline]{
                margin-right:30px;
            }

            app-drawer iron-icon {
                color: rgb(0, 136, 204);
                margin-right: 20px;

            }

            .logo {
                width: 134px;
            }

            a {
                color: var(--paper-blue-900);
            }

            .subitem{
                font-weight:700;
                font-size:larger;
                letter-spacing:1.5px;
            }


            h1{
                color:blue;
            }

            #versionDialog{
                text-align:center;
            }
            #settings{
                padding:20px;
            }
        </style>

        <app-location id="location" route="{{route}}" use-hash-as-path></app-location>
        <app-route id="router"
                route="{{route}}"
                pattern="/:page"
                data="{{routeData}}"></app-route>

        <paper-dialog id="versionDialog">
            <img src="resources/images/existdb.png" style="width:120px;">
            <div id="version"></div>
        </paper-dialog>

        <iron-ajax id="getVersion"
                   with-credentials
                   method="get"
                   handle-as="text"
                   on-response="_handleVersion"
                   url="/exist/apps/existdb-dashboard/modules/dashboard.xql"></iron-ajax>

        <app-drawer-layout id="drawerLayout" fullbleed>
            <app-drawer id="drawer" slot="drawer">
                <div class="drawerbar">
                    <img class="logo" src="resources/images/existdb.png">
                    <div class="subitem">Dashboard</div>
                </div>

                <!--
                drawer items will be loaded dynamically dependent on the group a user has
                -->
                <!--<div id="listItems" class="drawer-items" role="listbox" slot="menu">-->
                <!--<paper-listbox id="menu" attr-for-selected="id">-->
                    <paper-item id="launcherItem" on-click="_showLauncher" role="menuitem">
                        Launcher
                        <paper-ripple></paper-ripple>
                    </paper-item>
                    <paper-item id="packageManagerItem" on-click="_showPackageManager" role="menuitem">
                        Package Manager
                        <paper-ripple></paper-ripple>
                    </paper-item>
                    <paper-item id="userManagerItem" on-click="_showUserManager" role="menuitem">
                        User Manager
                        <paper-ripple></paper-ripple>
                    </paper-item>
                    <!--<paper-item on-click="_showBackup">Backup</paper-item>-->
                    <paper-item id="settingsItem" on-click="_showSettings" role="menuitem">
                        Settings
                        <paper-ripple></paper-ripple>
                    </paper-item>
                <!--</paper-listbox>-->

                <!--</div>-->
            </app-drawer>
            <app-header-layout>
                <app-header slot="header">
                    <app-toolbar>
                        <paper-icon-button icon="menu" drawer-toggle on-click="_toggleDrawer"></paper-icon-button>
                        <div main-title>[[mainLabel]]</div>
                        <div class="righttool"><a href="index.html?logout=true">logout</a></div>
                        <iron-icon icon="info-outline" on-click="_showVersion"></iron-icon>
                    </app-toolbar>
                </app-header>

                <iron-pages id="pages" selected="{{routeData.page}}" attr-for-selected="name">
                    <div name="launcher">
                        <h1>launcher</h1>
                    </div>
                    <div name="packagemanager">
                        <h1>package manager</h1>
                    </div>
                    <div id="usermanager" name="usermanager"></div>
                    <div id="settings" name="settings">
                        <existdb-settings></existdb-settings>
                    </div>
                </iron-pages>

            </app-header-layout>
        </app-drawer-layout>

    </template>

    <script>
        class ExistdbDashboard extends Polymer.Element {
            static get is() {
                return 'existdb-dashboard';
            }

            static get properties() {
                return {
                    route:{
                        type:Object
                    },

                    mainLabel:{
                        type: String
                    }
                };
            }

            connectedCallback() {
                super.connectedCallback();
                console.log("dashboard connected");
            }

            ready(){
                super.ready();
                this.$.location.addEventListener('path-changed', event => this.routeChanged(event))
                if (!this.route || !this.route.path) {
                    this.route = {};
                    this.set('route.path', '/launcher');
/*
                    this.route.path = '/launcher';
                    this.notifyPath('route.path');
*/
                }
                if(this.route.path == '/usermanager'){
                    this._loadUserManager();
                }

            }

            routeChanged(event){
                console.log("route changed ",event);
                console.log("route changed ",this.route);
                var s = event.detail.value.substring(1);
                console.log("route changed ",s);

                if(this.$.drawerLayout.narrow){
                    this.$.drawer.close();
                }

                if(s == 'launcher'){
                    console.log('launcher');
                    this.mainLabel = 'Launcher';
                } else if(s == 'packagemanager'){
                    this.mainLabel = 'Package Manager';
                } else if(s == 'usermanager'){
                    this.mainLabel = 'User Manager';
                } else if(s == 'settings'){
                    this.mainLabel = 'Settings';
                }

            }

            _toggleDrawer() {
                this.$.drawer.toggle();
            }

            _handleLoad(){
                console.log("items: ", this.$.loadDashboard.lastResponse);
                this.menuItems = this.$.loadDashboard.lastResponse;
            }

            _showLauncher(e){
                console.log('show.... ', e);
                this.$.pages.select('launcher');
            }
            _showPackageManager(e){
                console.log('show.... ', e);
                this.$.pages.select('packagemanager');
/*
                if(this.$.drawerLayout.narrow){
                    this.$.drawer.close();
                }
*/
            }
            _showUserManager(e){
                this.$.pages.select('usermanager');
                this._loadUserManager();
            }

            _loadUserManager(){
                var um = document.createElement("existdb-usermanager");
                this.$.usermanager.appendChild(um);
            }

            _showSettings(e){
                this.$.pages.select('settings');
/*
                if(this.$.drawerLayout.narrow){
                    this.$.drawer.close();
                }
*/
            }

            _toggleDrawer(e){
                this.$.drawer.close();
//                this.$.drawer.notifyResize();
            }

            _showVersion(e){
                console.log('show version');
                this.$.getVersion.url = this.importPath + 'modules/getVersion.xql';
                this.$.getVersion.generateRequest();
            }

            _handleVersion(){
                this.$.version.innerHTML = this.$.getVersion.lastResponse;
                this.$.versionDialog.open();
            }

        }

        window.customElements.define(ExistdbDashboard.is, ExistdbDashboard);
    </script>
</dom-module>
